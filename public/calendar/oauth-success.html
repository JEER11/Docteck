<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Google Calendar OAuth Success</title>
  <style>
    body { background: #181a2e; color: #fff; display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; }
    .msg { font-size: 1.3rem; text-align: center; }
  </style>
</head>
<body>
  <div class="msg">Connecting your Google Calendar...<br/>You may close this window after sign-in.</div>
  <script>
    // Always postMessage to opener, even if no code, to prevent redirect to dashboard
    function getQueryParam(name) {
      const url = new URL(window.location.href);
      return url.searchParams.get(name);
    }
  const code = getQueryParam('code');
  const state = getQueryParam('state');
  const connected = getQueryParam('connected');
    let uid = 'demo-user';
    if (state) {
      try { uid = JSON.parse(decodeURIComponent(state)).uid || uid; } catch (e) {}
    }
    const hash = window.location.hash.substring(1);
    const params = new URLSearchParams(hash);
    const accessToken = params.get('access_token');
    if (window.opener) {
      const success = !!(code || accessToken || connected === '1');
      window.opener.postMessage({
        type: 'google-oauth',
        code,
        accessToken,
        uid,
        success
      }, '*');
      setTimeout(() => window.close(), 500);
    } else {
      document.body.innerHTML = '<div class="msg">OAuth success. You may close this window.</div>';
    }
  </script>
</body>
</html>
